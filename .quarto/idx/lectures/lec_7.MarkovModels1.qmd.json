{"title":"Markov Models","markdown":{"yaml":{"title":"Markov Models","format":{"revealjs":{"theme":"slides.scss","incremental":true,"slide-number":true,"logo":"../vchem.png","html-math-method":"katex","transition":"fade","background-transition":"fade","highlight-style":"ayu-mirage","footer":"[Back to Website](../index.html)\n"}},"editor_options":{"chunk_output_type":"console"},"editor":{"markdown":{"wrap":72}}},"headingText":"Learning Objectives and Outline","containsRefs":true,"markdown":"\n\n```{r}\n#| echo: false\n#| message: false\n#| warning: false\n\nlibrary(readr)\nlibrary(here)\nlibrary(gt)\nsource(here::here(\"_healthy-sick-dead/01-healthy-sick-dead_setup.r\"))\nsource(here('_healthy-sick-dead/functions_healthy-sick-dead.r'))\nsource(here(\"_healthy-sick-dead/02_healthy-sick-dead_process-parameters.r\"))\nsource(here(\"_healthy-sick-dead/04_healthy-sick-dead_discounting-and-cycle-adjustments.r\"))\nsource(here(\"_healthy-sick-dead/05_healthy-sick-dead_construct-transition-probability-matrices.r\"))\n```\n\n\n## Learning Objectives\n\n::: incremental\n-   Discuss pros and cons of decision modeling using decision trees vs.\n    a formal deterministic model\n\n-   Understand the components and structure of discrete time Markov\n    models\n\n-   Calculate Markov cycles by hand, using Markov bubble diagram\n\n-   Apply methods for Markov cycle correction\n:::\n\n## A Simple Disease Process\n\n::: incremental\n-   Suppose we want to model the cost-effectiveness of alternative\n    strategies to prevent a disease from occurring.\n-   We start with a healthy population of 25 year olds and there are\n    three health states people can experience:\n    1.  Remain **Healthy**\n    2.  Become **Sick**\n    3.  **Death**\n:::\n\n## A Simple Disease Process\n\n::: incremental\n-   Remaining healthy carries no utility decrement (utility weight = 1.0\n    per cycle in healthy state)\n-   Becoming sick carries a 0.25 utility decrement for the remainder of\n    the person's life (utility weight = 0.75)\n-   Death carries a utility value of 0.\n:::\n\n## A Simple Disease Process\n\n::: incremental\n-   There is no cost associated with remaining healthy.\n-   Becoming sick incurs \\$1,000 / year in costs.\n-   Becoming sick increases the risk of death by 300%.\n:::\n\n## A Simple Disease Process\n\nA country's health institute is considering five preventive care\nstrategies that reduce the risk of becoming sick:\n\n| Strategy | Description                                      | Cost         |\n|----------|--------------------------------------------------|--------------|\n| A        | Standard of Care                                 | \\$25/year    |\n| B        | Additional 4% reduction in risk of becoming sick | \\$1,000/year |\n| C        | 12% reduction in risk                            | \\$3,100/year |\n| D        | 8% reduction in risk                             | \\$1,550/year |\n| E        | 8% reduction in risk                             | \\$5,000/year |\n\n## Model Option 1: Decision Tree\n\n-   One option would be to use a decision tree to model the expected\n    utility and costs associated with each strategy.\n-   Model time horizon: 10 years\n-   The next slide shows the decision tree for outcomes experienced in\n    the first year.\n\n##  {background-image=\"images/paste-01F7F5A9.png\" data-background-size=\"contain\"}\n\n<!-- Note: Data to construct are contained in media/decision_tree_markov_health_sick_dead_1y.Rdata -->\n\n## Model Option 1: Decision Tree {background-image=\"images/paste-01F7F5A9.png\" data-background-size=\"contain\" background-opacity=\"0.4\"}\n\n-   What limitations do you see?\n\n##  {background-image=\"images/paste-55AF9B31.png\" data-background-size=\"contain\"}\n\nDecision tree for two full cycles.\n\n<!-- Note: Data to construct are contained in media/decision_tree_markov_health_sick_dead_2y.Rdata -->\n\n##  {background-image=\"images/paste-AAAFE3F8.png\" data-background-size=\"contain\"}\n\nStrategy A decision tree for 5 cycles.\n\n<!-- Note: Data to construct are contained in media/decision_tree_markov_health_sick_dead_5y.Rdata -->\n\n## Decision Trees\n\n| Pros                                 | Cons |\n|--------------------------------------|------|\n| Simple, rapid & can provide insights |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons |\n|--------------------------------------|------|\n| Simple, rapid & can provide insights |      |\n| Easy to describe & understand        |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons |\n|--------------------------------------|------|\n| Simple, rapid & can provide insights |      |\n| Easy to describe & understand        |      |\n| Works well with limited time horizon |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons                                 |\n|------------------------------------|------------------------------------|\n| Simple, rapid & can provide insights | Difficult to include clinical detail |\n| Easy to describe & understand        |                                      |\n| Works well with limited time horizon |                                      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons                                   |\n|------------------------------------|------------------------------------|\n| Simple, rapid & can provide insights | Difficult to include clinical detail   |\n| Easy to describe & understand        | Elapse of time is not readily evident. |\n| Works well with limited time horizon |                                        |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons                                                |\n|------------------------------------|------------------------------------|\n| Simple, rapid & can provide insights | Difficult to include clinical detail                |\n| Easy to describe & understand        | Elapse of time is not readily evident.              |\n| Works well with limited time horizon | Difficult to model longer (\\>1 cycle) time horizons |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n![](images/markov1.png)\n\n## Next Steps\n\n-   Ideally we want a modeling approach that can incorporate flexibility\n    and handle the complexities that make decision trees\n    difficult/unwieldy.\n\n# Markov Models {background=\"#43464B\"}\n\n## Markov Models\n\nCommon approach in decision analyses that adds additional flexibility.\n\n| Pros                                  | Cons |\n|---------------------------------------|------|\n| Can model repeated events             |      |\n| $\\quad \\quad \\quad \\quad \\quad \\quad$ |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Markov Models\n\nCommon approach in decision analyses that adds additional flexibility.\n\n| Pros                                                  | Cons |\n|-------------------------------------------------------|------|\n| Can model repeated events                             |      |\n| Can model more complex + longitudinal clinical events |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Markov Models\n\nCommon approach in decision analyses that adds additional flexibility.\n\n| Pros                                                        | Cons |\n|-------------------------------------------------------------|------|\n| Can model repeated events                                   |      |\n| Can model more complex + longitudinal clinical events       |      |\n| Not computationally intensive; efficient to model and debug |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Markov Models\n\n::: incremental\n-   The advantages of Markov models derive from their structure around\n    mutually exclusive disease states.\n\n-   These disease states represent the possible states or consequences\n    of strategies or options under consideration.\n\n-   Because there are a fixed number of disease states the population\n    can be in, there is no need to model complex pathways, as we saw in\n    the decision tree \"explosion\" a few slides back.\n:::\n\n## Markov Trees\n\nIt is also common to pair a Markov model with a decision tree.[^1]\n\n[^1]: Gasauskas et al. 2022\n\n::: columns\n::: {.column width=\"50%\"}\n![](media/lec_conceptual-and-theoretical-frameworks/dt_hboc.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n:::\n:::\n\n## Markov Trees\n\nIt is also common to pair a Markov model with a decision tree.[^2]\n\n[^2]: Gasauskas et al. 2022\n\n::: columns\n::: {.column width=\"50%\"}\n![](media/lec_conceptual-and-theoretical-frameworks/dt_hboc.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](media/lec_conceptual-and-theoretical-frameworks/mar_hboc.png){fig-align=\"center\"}\n:::\n:::\n\n## Markov Tree {.smaller}\n\nA simple decision tree is implicit in nearly every decision analysis.\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-13DB786D.png){fig-align=\"center\" height=\"500px\"}\n:::\n\n::: {.column width=\"50%\"}\n:::\n:::\n\n## Markov Tree: Example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-13DB786D.png){fig-align=\"center\" height=\"500px\"}\n:::\n\n::: {.column width=\"50%\"}\nTreatment A:![](images/paste-BA42AD3E.png)\n:::\n:::\n\n## Markov Tree: Example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/caroline_model1.png){fig-align=\"center\" height=\"500px\"}\n:::\n\n::: {.column width=\"50%\"}\nTreatment A:![](images/caroline_model2.png)\n:::\n:::\n\n## When choosing a model structure...\n\n<br>\n\n> \"Things should be made as simple as possible, but not simpler\" -\n> Albert Einstein\n\n::: notes\n(1) When choosing a model structure, you want to choose one that best\n    fits your research question & one that adequately represents the\n    clinical background/problem -- zeroing in on what's most important\n\n(2) You always want to first build the structure completely\n    independently & data free AND then see how hard it is to get data +\n    calibrate\n\n(3) **You never want to model based on the data**\\* nor do you ever want\n    to make something complicated just to make it complicated\\*\\*\n\n(4) Just because a model is \"super complicated/complex\" doesn't mean\n    it's more publishable or better than something that's more\n    simplistic\n:::\n\n```{r, eval = FALSE}\n#| echo = FALSE\n\n\nlibrary(tidygraph)\nlibrary(ggraph)\nlibrary(igraph)\nlibrary(DiagrammeR)\n\ndt_healthysickdead <- \n  mermaid(\"graph LR\n    Healthy0[ ]---|Healthy|Healthy[ ]\n    Healthy---|Treatment A|TxA(M)\n    Healthy---|Treatment B|TxB(M)\n    Healthy---|Treatment C|TxC(M)\n    Healthy---|Treatment D|TxD(M)\n    Healthy---|Treatment E|TxE(M)\n    style Healthy0 fill:#ffffff,stroke:#333,stroke-width:0px\n    style TxA fill:#ffffff,stroke:#333,strike-width:0px\n    style TxB fill:#ffffff,stroke:#333,strike-width:0px\n    style TxC fill:#ffffff,stroke:#333,strike-width:0px\n    style TxD fill:#ffffff,stroke:#333,strike-width:0px\n    style TxE fill:#ffffff,stroke:#333,strike-width:0px\"); dt_healthysickdead \n\n\n## Treatment A\n\nm_P <- matrix(c(\n  0.9822,0,0.0178,\n               0.1376, .8556,0.0068,\n                0,0,1),\n              nrow=3,\n              byrow=TRUE,\n              dimnames=list(c(\"Sick\",\"Healthy\",\"Dead\"),\n                            c(\"Sick\",\"Healthy\",\"Dead\"))); m_P\n\n\ng <- graph.adjacency(m_P>0, mode=\"directed\", weighted=TRUE)\nE(g)$weight2 <- sprintf(c(.9822,.0178,.1376,.8556,.0068,1.00),fmt=\"%3.3f\")\n\ncurve.reciprocal.edges <- function(g, curve=.3){\n  # Return a graph where the edge-attribute $curved is reset to highlight reciprocal edges\n  el <- t(apply(get.edgelist(g),1,sort))\n  E(g)$curved <- 0\n  E(g)[duplicated(el) | duplicated(el,fromLast =TRUE)]$curved <- curve\n  (g)\n}\n\nset.seed(12343)\nplot(curve.reciprocal.edges(g), vertex.size=100, \n     vertex.color = \"white\",\n     vertex.label.color = \"black\",\n     edge.label = E(g)$weight2 ,\n     arrow.size=100, label.cex=3)\n\n```\n\n# Constructing a Markov Model {background=\"#43464B\"}\n\n## Key characteristics {.smaller}\n\n::: incremental\n-   Allows for health state transitions [over\n    time]{style=\"background-color: yellow;\"}\n-   Individuals can only exist in one state at a time (mutually\n    exclusive health states)\n-   At the beginning or end of each cycle, patients transition across\n    health states via transition probabilities & individuals stay in\n    health state [for entire cycle\n    length]{style=\"background-color: yellow;\"}\n-   Probability of transitioning depends on the current state (\"no\n    memory\"); (tunnel states can account for this potential limitation)\n-   Transition probabilities remain constant over time (apart from\n    embedded lifetables)\n-   Results report \"average\" of cohort\n:::\n\n## Key characteristics {.smaller}\n\n<br>\n\n> \"CYCLE\" = Minimum amount of time that any individual will spend in a\n> state before possible transition to another state\n\n-   More on this in the next slides\n\n## Steps\n\n1.  Define the decision problem\n2.  Conceptualize the model\n3.  Parameterize the model\n4.  Calculate or define the transition probability matrix\n5.  Run the model\n\n# 1. Define the Decision Problem {background=\"#c2f0c2\"}\n\n## Step 1: Define the Decision Problem\n\nWe defined the decision problem earlier in this lecture, so we'll repeat\nthe basic objectives briefly here.\n\n## Step 1: Define the Decision Problem\n\n**Goal:** model the cost-effectiveness of alternative strategies to\nprevent a disease from occurring.\n\n| Strategy | Description                                      | Cost         |\n|----------|--------------------------------------------------|--------------|\n| A        | Standard of Care                                 | \\$25/year    |\n| B        | Additional 4% reduction in risk of becoming sick | \\$1,000/year |\n| C        | 12% reduction in risk                            | \\$3,100/year |\n| D        | 8% reduction in risk                             | \\$1,550/year |\n| E        | 8% reduction in risk                             | \\$5,000/year |\n\n## Step 1: Define the Decision Problem\n\n![](images/paste-13DB786D.png){fig-align=\"center\"}\n\n# 2. Conceptualize the Markov Model {background=\"#c2f0c2\"}\n\n## 2. Conceptualize the Markov Model\n\nTwo major steps:\n\n### {{< fa check-circle >}} 2a. Determine health states\n\n### {{< fa check-circle >}} 2b. Determine transitions\n\n## Step 2: Conceptualize the Model\n\n### {{< fa check-circle >}} 2a. Determine health states\n\n::: incremental\n-   There are three health states people can experience:\n    1.  Remain **Healthy**\n    2.  Become **Sick**\n    3.  **Death**\n:::\n\n## Step 2: Conceptualize the Model\n\n### {{< fa check-circle >}} 2a. Determine health states\n\n::: nonincremental\n-   There three health states people can experience:\n    1.  Remain **Healthy**\n    2.  Become **Sick**\n    3.  **Death**\n:::\n\n### {{< fa check-circle >}} 2b. Determine transitions\n\n::: incremental\n-   Individuals who become sick cannot transition back to healthy.\n:::\n\n## \"Bubble Diagram\"\n\nState transition (\"bubble\") diagrams are useful visualizations of a\nMarkov model.\n\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy;\n    Sick -> Sick;\n    Healthy -> Sick; \n    Sick -> Dead;\n    Healthy -> Dead;\n    Dead -> Dead;\n  }\n```\n\n::: footer\nDiagram constructed using the [Graphviz Visual\nEditor](http://magjac.com/graphviz-visual-editor/)\n:::\n\n# 3. Parameterize the Model {background=\"#c2f0c2\"}\n\n## 3. Parameterize the Model\n\nBasic steps\n\n### {{< fa check-circle >}} 3a. Determine basic model parameters\n\n### {{< fa check-circle >}} 3b. Curate and define model inputs\n\n## 3. Parameterize the Model\n\nBasic steps\n\n### {{< fa check-circle >}} 3a. Determine basic model parameters\n\n::: incremental\n-   Define the population (e.g., 25 year old females)\n-   Define the Markov cycle length (e.g., 1-year cycle)\n-   Define the time horizon (e.g., followed until age 100 or death)\n:::\n\n## 3a. Define the Markov Cycle Length\n\n<!-- https://www.youtube.com/watch?v=bVlMq67HT48 -->\n\n::: incremental\n-   Fundamentally, we're modeling a continuous time process (e.g.,\n    progression of disease).\n-   A discrete time Markov model \"breaks up\" time into \"chunks\" (i.e.,\n    \"cycles\").\n-   A consequence is that the model will show us what fraction start out\n    a cycle in a given state, and what fraction end up in each state at\n    the end of the cycle.\n:::\n\n## 3a. Define the Markov cycle length\n\n::: incremental\n-   Suppose we used a one-year cycle for the healthy-sick-dead model.\n-   Think about the underlying (continuous time) disease process.\n    -   Recall that becoming sick substantially increases the likelihood\n        of death.\n-   If we're not careful, what are we (implicitly) assuming *can* and\n    *can't* happen in a single cycle?\n:::\n\n## 3a. Define the Markov Cycle Length\n\n::: {style=\"padding-top: 200px;\"}\n![](images/paste-9C03CB85.png)\n\n```{r, eval = FALSE}\n#| echo: false\nlibrary(DiagrammeR)\nmermaid(\"\ngantt\n  title One-Year Cycle Length\n  dateFormat  YYYY-MM-DD\n  section Health States\n  Healthy : 2021-01-01, 59d\n  Sick     : 2021-03-01 , 100d\n  Dead     : 2021-06-09 , 206d\n  \")\n```\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\nThe challenge of selecting an appropriate cycle length boils down to how\nwe deal with **competing risks**.\n\n::: columns\n::: {.column width=\"50%\"}\n::: incremental\n-   Competing risks: individuals can transition from their current\n    health state to two or more other health states.\n:::\n:::\n\n::: {.column width=\"50%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy;\n    Sick -> Sick;\n    Healthy -> Sick [color=\"red\"]; \n    Sick -> Dead;\n    Healthy -> Dead [color=\"red\"];\n    Dead -> Dead;\n  }\n```\n:::\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\nThe challenge of selecting an appropriate cycle length boils down to how\nwe deal with **competing risks**.\n\n::: columns\n::: {.column width=\"50%\"}\n::: incremental\n-   If we're not careful, we could effectively rule out the possibility\n    of Healthy {{< fa arrow-right-long >}}\n    Sick{{< fa arrow-right-long >}} Dead within a cycle.\n-   The model would *look like* a basic Healthy\n    {{< fa arrow-right-long >}} Dead transition, but they took a detour\n    through Sick along the way!\n:::\n:::\n\n::: {.column width=\"50%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy;\n    Sick -> Sick;\n    Healthy -> Sick [color=\"blue\"]; \n    Sick -> Dead [color=\"blue\"];\n    Healthy -> Dead [color=\"red\"];\n    Dead -> Dead;\n  }\n```\n:::\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n| Pros                                                        | Cons                            |\n|----------------------------------------------|--------------------------|\n| Can model repeated events                                   | Competing risks are a challenge |\n| Can model more complex + longitudinal clinical events       |                                 |\n| Not computationally intensive; efficient to model and debug |                                 |\n\n## 3a. Define the Markov Cycle Length\n\n-   It may be tempting to simply shorten the cycle length (e.g., use 1\n    day cycle vs. 1 year cycle).\n\n::: incremental\n-   For a 75 year horizon, how many cycles would that be?\n    -   27,375!!!\n-   Any possible issues with this?\n:::\n\n## 3a. Define the Markov Cycle Length\n\n-   Shortening the cycle creates a computational challenge.\n\n::: incremental\n-   Base case requires 27,375 daily cycles.\n-   Now suppose we want to run 2,000 probabilistic sensitivity analysis\n    model runs.\n    -   We now have 57,750,000 cycle runs to contend with!\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n| Pros                                                        | Cons                                                      |\n|------------------------------------|------------------------------------|\n| Can model repeated events                                   | Can only transition once in a given cycle                 |\n| Can model more complex + longitudinal clinical events       | Shortening the cycle can create computational challenges. |\n| Not computationally intensive; efficient to model and debug |                                                           |\n\n## 3a. Define the Markov Cycle Length\n\nMore challenges ...\n\n## 3a. Define the Markov Cycle Length\n\nMore challenges ...\n\n-   Markov models are \"memoryless\" -- they don't remember what happened\n    before the current cycle.\n    -   If your risk of transition to a sicker health state depends on\n        events that happened earlier in time, the model can't explicitly\n        account for this.\n\n## 3a. Define the Markov Cycle Length\n\nMore challenges ...\n\n-   There are workarounds known as \"tunnel states\" to get around this\n    problem, though these are difficult to do and present their own\n    challenges\n    -   We won't cover them this week but we can provide references if\n        you want to explore!\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n| Pros                                                        | Cons                                                                   |\n|------------------------------------|------------------------------------|\n| Can model repeated events                                   | Can only transition once in a given cycle                              |\n| Can model more complex + longitudinal clinical events       | Shortening the cycle can create computational challenges.              |\n| Not computationally intensive; efficient to model and debug | Shortening cycle can cause \"state explosion\" if tunnel states are used |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n::: incremental\n-   It's also advisable to pick a cycle length that aligns with the\n    clinical/disease timelines of the decision problem.\n    -   Treatment schedules.\n    -   Acute vs. chronic condition.\n-   Another option is to incorporate \"short-run\" events that happen\n    early in the course of a disease/intervention within the decision\n    tree, then allow the Markov model to model longer-term health\n    consequences.\n:::\n:::\n\n::: {.column width=\"50%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"];\n    Healthy -> Healthy ;\n    Sick -> Sick ;\n    Healthy -> Sick ; \n    Sick -> Dead ;\n    Healthy -> Dead;\n    Dead -> Dead;\n  }\n```\n:::\n:::\n\n## 3. Parameterize the Model\n\n### {{< fa check-circle >}} 3b. Curate and define model inputs\n\n::: nobullet\n-   {{< fa check-circle >}} 3b.i. Source and define the base case\n    values.\n\n-   {{< fa check-circle >}} 3b.ii. Source and define sources of\n    uncertainty.\n:::\n\n## 3. Parameterize the Model\n\n### {{< fa check-circle >}} 3b. Curate and define model inputs\n\n::: incremental\n-   Rate of disease onset\n-   Health state utilities and costs\n-   Hazard ratios, odds ratios or relative risks for different\n    strategies.\n-   ... and so on.\n:::\n\n## 3. Parameterize the Model\n\nWe defined many of the underlying parameters earlier in this lecture, so\nwe'll repeat them briefly here.\n\n## 3. Parameterize the Model\n\n-   We start with a healthy population of 25 year olds and follow them\n    until age 100 (or death, if earlier).\n\n::: incremental\n-   Remaining healthy carries no utility decrement (utility weight= 1.0)\n-   Becoming sick carries a 0.25 utility decrement for the remainder of\n    the person's life (utility weight = 0.75)\n-   Death carries a utility weight value of 0.\n:::\n\n## 3. Parameterize the Model\n\n-   There is no cost associated with remaining healthy.\n\n::: incremental\n-   Becoming sick incurs \\$1,000 / year in costs.\n-   Becoming sick increases the risk of death by 300%.\n:::\n\n## 3. Parameterize the Model\n\nEach strategy has a different cost and impact on the likelihood of\nbecoming sick.\n\n| Strategy | Description                                      | Cost         |\n|----------|--------------------------------------------------|--------------|\n| A        | Standard of Care                                 | \\$25/year    |\n| B        | Additional 4% reduction in risk of becoming sick | \\$1,000/year |\n| C        | 12% reduction in risk                            | \\$3,100/year |\n| D        | 8% reduction in risk                             | \\$1,550/year |\n| E        | 8% reduction in risk                             | \\$5,000/year |\n\n## 3. Parameterize the Model\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   Often, parameters are drawn from the published literature, and it is\n    important to track the source (published value, assumption, etc.)\n    for each model parameter.\n    -   For example, the percent risk reduction parameter for each\n        strategy may come from different clinical trials.\n    -   The parameter governing death from background causes may be\n        derived from mortality data.\n:::\n\n## 3. Parameterize the Model {.smaller}\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   Some parameters may just be values (e.g., cost of Strategy A is\n    \\$25/yr)\n-   Some parameters may be functions of other parameters.\n    -   For example, suppose we want to follow a cohort of 25 year olds\n        until age 100 or death, if it occurs earlier.\n    -   In that case we have two \"fixed\" parameters: the starting age,\n        and the maximum age.\n    -   We can use these two parameters to infer the total number of\n        cycles we need to run.\n:::\n\n## 3. Parameterize the Model\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   Parameters also have various \"flavors\":\n    1.  Probabilities\n    2.  Rates\n    3.  Hazard ratios\n    4.  Costs\n    5.  Utilities\n    6.  etc.\n:::\n\n## 3. Parameterize the Model\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   All of the above highlight the importance of adopting a formal\n    process for naming and tracking the value, source, and uncertainty\n    distribution of **all** model parameters in one place.\n\n-   We recommend a structured approach based on parameter naming\n    conventions and parameter tables.\n:::\n\n## 3. Parameterize the Model\n\nNaming conventions:\n\n```{r}\nknitr::kable(\n  dplyr::tibble(\n    type = c(\"Probability\",\"Rate\",\"Matrix\",\"Cost\",\"Utility\",\"Hazard Ratio\"),\n    prefix = c(\"p_\",\"r_\",\"m_\",\"c_\",\"u_\",\"hr_\")\n  )\n)\n```\n\n## Parameter Table {.smaller}\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\n#| echo: false\n#| message: false\n#| warning: false\n\n\nrows_to_show <- c(1,2,13,14,17,19:21,41)\n\nparams_raw[rows_to_show,1:7]  %>% gt() %>% \n  tab_header(title = \"Parameter Table\") %>% \n  sub_missing(missing_text=\"\") %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#e1efda\")\n    ),\n    locations = cells_body(\n      rows = c(1:length(rows_to_show))\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#fce4d6\")\n    ),\n    locations = cells_body(\n      rows = c(length(rows_to_show))\n    )\n  ) %>% \n    tab_style(\n    style = list(\n      cell_fill(color = \"#ed7d31\")\n    ),\n    locations = cells_body(\n      columns = c(2),\n      rows = c(length(rows_to_show))\n    )\n  ) \n\n```\n:::\n\n##  {.smaller}\n\n**param** column is the short name of the parameter\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\n \n\nprint_table <- function(target) {\n  params_raw[rows_to_show,1:7]  %>% gt() %>% \n  tab_header(title = \"Parameter Table\") %>% \n  sub_missing(missing_text=\"\") %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#e1efda\")\n    ),\n    locations = cells_body(\n      rows = c(1:length(rows_to_show))\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#fce4d6\")\n    ),\n    locations = cells_body(\n      rows = c(length(rows_to_show))\n    )\n  ) %>% \n    tab_style(\n    style = list(\n      cell_fill(color = \"#ed7d31\")\n    ),\n    locations = cells_body(\n      columns = c(2),\n      rows = c(length(rows_to_show))\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_borders(\n        sides = c(\"left\",\"right\"),\n        color = \"darkred\",\n        weight = px(2)\n      )),\n      locations = cells_body(\n        columns = c(target)\n      \n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_borders(\n        sides = c(\"top\"),\n        color = \"darkred\",\n        weight = px(2)\n      )),\n      locations = cells_body(\n        rows = c(1),\n        columns = c(target)\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_borders(\n        sides = c(\"bottom\"),\n        color = \"darkred\",\n        weight = px(2)\n      )),\n      locations = cells_body(\n        rows = length(rows_to_show),\n        columns = c(target)\n    )\n  )\n}\n\nprint_table(1)\n\n\n```\n:::\n\n##  {.smaller}\n\n**base_case** is the parameter value for the base case.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(2)\n```\n:::\n\n##  {.smaller}\n\n**formula** defines model parameter formulas for parameters that are\nfunctions of other model parameters.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(3)\n```\n:::\n\n##  {.smaller}\n\n**description** provides a text description of the parameter.\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(4)\n```\n:::\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n##  {.smaller}\n\n**notes** is an optional column where you add additional notes or\ncontext for the parameter.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(5)\n```\n:::\n\n##  {.smaller}\n\n**distribution** specifies the uncertainty distribution for the\nparameter. It is used for probabilistic sensitivity analyses, which we\ncover in our intermediate (week-long) workshop.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(6) %>% tab_options(table.width = pct(100))\n```\n:::\n\n##  {.smaller}\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n**source** provides the source for the parameter. It could be a\npublished research article, an assumption, or just simply an unsourced\nmodeling parameter (e.g., the starting age of the modeled cohort).\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(7)\n```\n:::\n\n# 4. Calculate or define the transition probability matrix {background=\"#c2f0c2\"}\n\n## Defining the Transition Probability Matrix\n\n-   The transition probability matrix is a square matrix that defines\n    the probability of transitioning from one health state to another\n    health state in a single time step.\n\n-   Constructing the matrix is a fairly technical, but fairly\n    straightforward process.\n\n    -   We will skip over this process for now, but come back to it later today!\n\n## Transition Probability Matrix\n\n::: columns\n::: {.column width=\"40%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy [label=\"0.856\"];\n    Sick -> Sick [label=\"0.982\"];\n    Healthy -> Sick [label=\"0.138\"]; \n    Sick -> Dead [label=\"0.018\"];\n    Healthy -> Dead [label=\"0.007\"];\n    Dead -> Dead [label=\"1.0\"];\n  }\n```\n:::\n\n::: {.column width=\"50%\"}\n|         | Healthy | Sick  | Dead  |\n|---------|---------|-------|-------|\n| Healthy | 0.856   | 0.138 | 0.007 |\n| Sick    | 0       | 0.982 | 0.018  |\n| Dead    | 0       | 0     | 1     |\n:::\n:::\n\n# 5. Run the Model {background=\"#c2f0c2\"}\n\n## Executing the model requires two inputs {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-vstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\n$\\quad \\quad \\quad \\quad \\quad \\quad \\quad \\quad$\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns %>% round(.,3)\n```\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$\\quad \\quad \\quad \\quad$\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns %>% round(.,3)\n```\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP \n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns\n```\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr1\"}\n```{r}\ns%*% P %>% round(.,3)\n```\n:::\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n```{r}\n(s %*% P) %*% P %>% round(.,3)\n```\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr1\"}\n```{r}\ns%*% P %>% round(.,3)\n```\n:::\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr2\"}\n```{r}\n(s%*% P) %*% P %>% round(.,3)\n```\n:::\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n```{r}\n(s %*% P) %*% P %>% round(.,3)\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr3\"}\n```{r}\n((s %*% P) %*% P) %*% P %>% round(.,3)\n```\n:::\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n\n::: {data-id=\"tr1\"}\n```{r}\ns %*% P\n```\n:::\n\n::: {data-id=\"tr2\"}\n```{r}\n(s %*% P) %*% P\n```\n:::\n\n::: {data-id=\"tr3\"}\n```{r}\n((s %*% P) %*% P) %*% P \n```\n:::\n\n## Markov Trace {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy Over Ten Cycles\n:::\n\n```{r}\n0:10 %>% map_df(~(s %*% (P %^% .x) %>% data.frame()))  %>% \n  mutate(cycle = 0:10) %>% \n  select(cycle,everything()) %>% \n  print(row.names=FALSE)\n  \n```\n\n##  {data-visibility=\"hidden\"}\n\n```{mermaid}\ngraph LR\n        subgraph Step 1\n        A[ ]==>|Parameterize|Software\n        end\n        Software -->Excel\n        Software -->R\n        Excel --> ExcelModelType[Model Type]\n        R --> RModelType[Model Type]\n        ExcelModelType --> ExcelMarkov[Markov]\n        RModelType --> RMarkov[Markov]\n        RModelType --> RMicro[Microsimulation]\n        RModelType --> RDES[Discrete Event Simulation]\n        style A fill:#ffffde,stroke:#333,stroke-width:0px\n      \n```\n\n## A Markov Model of Cancer {data-visibility=\"hidden\"}\n\n```{dot}\n//| fig-align: center\n//| fig-width: 10\n\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    \"Stage 1\" [pos=\"-1.5,-1!\"];\n    \"Stage 2\" [pos=\"0,-1!\"];\n    \"Stage 3\" [pos=\"1.5,-1!\" ];\n    \"Remission\" [pos=\"-1.5,-2!\"];\n    Death [pos=\"1.5,-2!\"];\n    Healthy -> \"Stage 1\";\n    Healthy -> Healthy;\n    Healthy ->\"Stage 2\";\n    Healthy -> \"Stage 3\";\n    Healthy -> Death;\n    \"Stage 1\" -> Death; \n    \"Stage 2\" -> Death; \n    \"Stage 3\" -> Death;\n    \"Stage 1\" -> Remission; \n    Remission -> \"Stage 1\";\n    \"Stage 2\" -> Remission; \n    Remission -> \"Stage 2\"; \n    Remission -> Remission; \n    \"Stage 1\" -> \"Stage 1\"\n    \"Stage 2\" -> \"Stage 2\" \n    \"Stage 3\" -> \"Stage 3\"\n    Remission -> Death;\n    \"Stage 1\" -> \"Stage 2\"; \n    \"Stage 2\" -> \"Stage 1\"; \n    \"Stage 2\" -> \"Stage 3\";\n    \"Stage 3\" -> \"Stage 2\"; \n  }\n```\n\n## Transition Probability Matrix {.smaller data-visibility=\"hidden\"}\n\n::: columns\n::: {.column width=\"65%\"}\n```{r}\nround(m_P[[1]],3)  %>% knitr::kable()\n```\n:::\n\n::: {.column width=\"5%\"}\n:::\n\n::: {.column width=\"30%\"}\n-   test\n:::\n:::\n\n::: {#refs}\n:::\n\n# Calculate cycles by hand {background=\"#c2f0c2\"}\n\n## In-class example {.smaller}\n\n::: incremental\n-   A new drug was developed for cancer patients in remission to\n    decrease their chance of relapse\n-   This drug is \\$10,000 per year (2022 USD)\n-   Research question: Is the new drug cost-effective compared to the\n    current standard of care?\n-   Let's say we want to model this over a 4-year time horizon\n:::\n\n## In-class example {.smaller}\n\n<br>\n\n::: {style=\"font-size: 0.6em\"}\n|                      | Standard of Care | New Drug |\n|----------------------|------------------|----------|\n| Healthy to Stage 1   | 5%               |          |\n| Healthy to Stage 2   | 2%               |          |\n| Healthy to Stage 3   | 1%               |          |\n| Stage 1 to Stage 2   | 10%              |          |\n| Stage 1 to Remission | 25%              |          |\n| Stage 2 to Stage 1   | 5%               |          |\n| Stage 2 to Stage 3   | 15%              |          |\n| Stage 2 to Remission | 20%              |          |\n| Stage 3 to Stage 2   | 5%               |          |\n| Stage 3 to Death     | 45%              |          |\n| Remission to Stage 1 | 10%              | 2%       |\n| Remission to Stage 2 | 5%               | 1%       |\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example1.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example2.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example3.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example4.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example5.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example7.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example8.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-NewDrug.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example9.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example10.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example9.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example11.png){fig-align=\"center\"}\n:::\n:::\n\n<!-- ## In-class example {.smaller} -->\n\n<!-- <br> -->\n\n<!-- Markov model be continued in class next week... -->\n\n# Calculating Outcomes {background=\"#c2f0c2\"}\n\n## An example Markov Trace (75 year horizon)\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  |\n|----------|---------|-------|-------|\n| 0        | 1.000   | 0.000 | 0.000 |\n| 1        | 0.856   | 0.138 | 0.007 |\n| 2        | 0.732   | 0.253 | 0.015 |\n| 3        | 0.626   | 0.349 | 0.025 |\n| 4        | 0.536   | 0.429 | 0.035 |\n| 5        | 0.458   | 0.495 | 0.046 |\n| ...      | ...     | ...   | ...   |\n| 75 (End) | 0       | 0.282 | 0.718 |\n:::\n\n## Markov Traces\n\n-   Often we are modeling several competing strategies.\n-   Each strategy has its own transition probability matrix.\n-   Therefore, each strategy will have it's own Markov trace.\n\n## Calculating Outcomes\n\n-   With our markov traces complete, we can calculate expected outcomes\n    (e.g., costs, QALYs, DALYs, etc.).\n-   Much like we did with decision trees, we need to define \"payoffs\"\n    for each health state.\n\n## Defining Payoffs\n\n-   Cost outcomes: Cost of being healthy, sick, dead (including any\n    additional costs of treatment/intervention, if applicable).\n-   QALY outcomes: Utility weight of being healthy (usually 1.0), sick,\n    dead (usually 0.0).\n-   DALY outcomes: Disability weights of being sick (YLD) and remaining\n    life expectancy based on reference life table (YLL)\n\n## Defining Payoffs\n\n::: nonincremental\n-   We can calculate the total payoff for each cycle by multiplying the\n    number or fraction of the cohort in each health state by its payoff\n    value, and adding them together.\n:::\n\nExample Markov Trace (two cycles):\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  |\n|-------|---------|-------|-------|\n| 0     | 1.000   | 0.000 | 0.000 |\n| 1     | 0.856   | 0.138 | 0.007 |\n:::\n\n## Example: Life Years\n\n-   We'll build our example using a simple outcome: expected life years\n    under a given strategy.\n-   Payoffs:\n    -   Healthy: <span style=\"color:green;\">1.0</span>\n    -   Sick: <span style=\"color:green;\">1.0</span> \\[they're still alive!\\]\n    -   Dead: <span style=\"color:green;\">0.0</span>\n\n## Example: Life Years\n\n-   To get the total \"payoff\" for a given cycle, we multiply the\n    fraction of the cohort in a given health state by the payoff\n    associated with that health state.\n-   Do this for each health state, and add them together to get the\n    total.\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY  |\n|-------|---------|-------|-------|-----|\n| 0     | 1.000   | 0.000 | 0.000 |     |\n| 1     | 0.856   | 0.138 | 0.007 |     |\n:::\n\n## Example: Life Years\n\nWhat is the LY \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY  |\n|-------|---------|-------|-------|-----|\n| 0     | 1.000   | 0.000 | 0.000 |     |\n| 1     | 0.856   | 0.138 | 0.007 |     |\n:::\n\n## Example: Life Years\n\nWhat is the LY \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY  |\n|-------|---------|-------|-------|-----|\n| 0     | 1.000   | 0.000 | 0.000 | 1.0 = 1.0 \\* <span style=\"color:green;\">1.0</span> + 0.0 \\* <span style=\"color:green;\">1.0</span> + 0.0 \\* <span style=\"color:green;\">0.0</span>|\n| 1     | 0.856   | 0.138 | 0.007 |     |\n:::\n\n## Example: Life Years\n\nWhat is the LY \"payoff\" for Cycle 1?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY                                            |\n|---------------|---------------|---------------|---------------|---------------|\n| 0     | 1.000   | 0.000 | 0.000 | 1.0                                           |\n| 1     | 0.856   | 0.138 | 0.007 | 0.994 = 0.856 * <span style=\"color:green;\">1.0</span> + 0.138 \\* <span style=\"color:green;\">1.0</span> + 0.007 \\* <span style=\"color:green;\">0.0</span> |\n:::\n\n... and so on.\n\n## Example: Life Years\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY                    |\n|----------|---------|-------|-------|-----------------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                     |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993                 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985                 |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975                 |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965                 |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954                 |\n| ...      | ...     | ...   | ...   |                       |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282                 |\n:::\n\n\n## Example: Costs\n\n-   Now suppose we want to calculate costs.\n-   Payoffs:\n    -   Healthy: <span style=\"color:blue;\">\\$0</span>\n    -   Sick: <span style=\"color:blue;\">\\$1,000</span>\n    -   Dead: <span style=\"color:blue;\">\\$0</span>\n\n## Example: Costs\n\nWhat is the Cost \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | Cost |\n|-------|---------|-------|-------|------|\n| 0     | 1.000   | 0.000 | 0.000 |      |\n| 1     | 0.856   | 0.138 | 0.007 |      |\n:::\n\n## Example: Costs\n\nWhat is the Cost \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | Cost |\n|-------|---------|-------|-------|------|\n| 0     | 1.000   | 0.000 | 0.000 | 0 = 1.00 \\* <span style=\"color:blue;\">0</span> + 0.0 \\* <span style=\"color:blue;\">1000</span> + 0.0 \\* <span style=\"color:blue;\">0</span>   |\n| 1     | 0.856   | 0.138 | 0.007 |      |\n:::\n\n## Example: Costs\n\nWhat is the cost \"payoff\" for Cycle 1?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | Cost                                |\n|-------|---------|-------|-------|-------------------------------------|\n| 0     | 1.000   | 0.000 | 0.000 | 0                                   |\n| 1     | 0.856   | 0.138 | 0.007 | 138 = 0.856\\*<span style=\"color:blue;\">0</span>+0.138\\*<span style=\"color:blue;\">1000</span>+0.007\\*<span style=\"color:blue;\">0</span> |\n:::\n\n... and so on.\n\n\n## Other Outcomes\n\n- We can repeat a similar process for health outcomes (e.g., QALYs, YLDs) by multiplying the \"payoff\" (e.g., utility weight, disability weight) for a given health state by the fraction of the cohort in that health state in the cycle. \n\n# Calculating Total Expected Outcomes\n\n## Total Outcomes \n\n## Total Life Years \n\nLet's look at the Markov trace and cycle outcomes for the Life Year outcome.\n\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle)     |\n|----------|---------|-------|-------|-----------------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                     |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993                 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985                 |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975                 |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965                 |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954                 |\n| ...      | ...     | ...   | ...   |                       |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282                 |\n:::\n\n## Life years\n\nWe can create a new column that accumulates life years over each cycle. \n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle) | LY (cumulative)   |\n|----------|---------|-------|-------|-------------------|-------------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                 | 1                 |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993             | 1 + 0.993 = 1.993 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985             |                   |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975             |                   |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965             |                   |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954             |                   |\n| ...      | ...     | ...   | ...   | ...               |                   |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282             |                   |\n:::\n\n## Life years\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle) | LY (cumulative)           |\n|------------|------------|------------|------------|------------|------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                 | 1                         |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993             | 1.993                     |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985             | 1 + 0.993 + 0.985 = 2.978 |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975             |                           |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965             |                           |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954             |                           |\n| ...      | ...     | ...   | ...   | ...               |                           |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282             |                           |\n:::\n\n## Life years {.smaller}\n\n-   The cumulative LYs for an individual starting in the Healthy state is **44.825**\n\n-   Note that this is within a 75 years time horizon\n\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle) | LY (cumulative) |\n|----------|---------|-------|-------|-------------------|-----------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                 | 1               |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993             | 1.993           |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985             | 2.978           |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975             | 3.954           |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965             | 4.919           |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954             | 5.872           |\n| ...      | ...     | ...   | ...   | ...               | ...             |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282             | **44.825**      |\n:::\n\n\n## Total Outcomes\n\n- We can do a similar exercise to get total costs, total QALYs, total DALYs, etc.\n- However, it's not that simple. There are some extra complications we have to deal with.\n  - Discounting \n  - Cycle correction\n\n# Cycle correction {background=\"#c2f0c2\"}\n\n## The problem\n\n-   In real life, events could occur at any points in a given cycle, but\n    a Markov model assumes all events occur either at the beginning\n    or end of each cycle\n    \n-   Time is continuous, so are survival/event-free survival curves\n-   When we discretize time by using a fixed cycle length, we can make\n    two assumptions\n    -   Suppose this is a simple Well $\\rightarrow$ Dead process\n\n## The problem {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n::: fragment\nAssuming death happens at the end of cycle\n(A)![](images/paste-48DC2C4B.png){fig-align=\"center\" width=\"512\"}\n:::\n\n::: fragment\nOverestimates state membership in Well\n:::\n:::\n\n::: {.column width=\"50%\"}\n::: fragment\nAssuming death happens at the start of cycle\n(B)![](images/paste-6C74F22E.png){fig-align=\"center\" width=\"525\"}\n:::\n\n::: fragment\nUnderestimates state membership in Well\n:::\n:::\n:::\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## The problem {.smaller}\n\n![](images/half-cycle.png){width=\"513\"}\n\n::: notes\n1.  When counting subjects at the END of cycle (top visual) (transition\n    happens at beginning of cycle) - you would be underestimating LYs\n\n-   Say you have 10 people & 5 die halfway through, you wouldn't be\n    counting the 5 that started that has accumulated SOME costs &\n    benefits in that cycle; you would only be counting the \"end\"\n    survivors.\n\n2.  If you counted subjects at BEGINNING of cycle (the bottom visual)\n    (transition happens at end of previous cycle), you would be\n    overestimating LYs\n\n-   For example, for these 10 people, they die halfway through the\n    cycle, but you already gave that person the full cycle's benefits &\n    costs at the beginning (even though they shouldn't get the full\n    benefits & costs because they died halfway through)\n:::\n\n## Half-cycle correction\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-1105574D.png)\n:::\n\n::: {.column width=\"50%\"}\n:::\n:::\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## Half-cycle correction\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-F622FD0F.png)\n:::\n\n::: {.column width=\"50%\"}\n::: fragment\n![](images/paste-4F29D3CE.png)\n:::\n:::\n:::\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## Half-cycle correction {.smaller}\n\n![](images/paste-86501A0D.png){fig-align=\"center\"}\n\n-   Multiply the outcomes by 1/2 in the first and last cycle.\n\n-   Shifting the computed, discrete state membership curve to the left\n    by 1/2 cycle.\n\n-   Essentially assuming that events happen in the middle of cycle\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## Half-cycle correction\n\n<br>\n\n![](images/half-cycle2.png)\n\n::: notes\n(1) Intuition behind it -- the image to the left represents\n    underestimation\n\n(2) & you can see if you line that up to the Y-AXIS (center figures),\n    the triangular areas can be seen to be equal to a rectangle one-half\n    cycle wide extending from 0 to 1.\n\n(3) If you add back the original rectangles, the approximation is NOW\n    BETTER -- it has corrected for the underestimation.\n:::\n\n# Apply cycle correction methods to our markov trace...\n\n## Half-cycle correction {.smaller}\n\n-   Multiply the outcomes by 1/2 in the first and last cycle.\n\n::: fragment\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle, adjusted) | LY (cumulative)     |\n|------------|------------|------------|------------|------------|------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1**\\*0.5**                  | **0.5**             |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993                       | 0.5 + 0.993 = 1.493 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985                       | 2.478               |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975                       | 3.454               |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965                       | 4.419               |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954                       | 5.372               |\n| ...      | ...     | ...   | ...   | ...                         | ...                 |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282 **\\*0.5**             | **44.184**          |\n:::\n:::\n\n::: fragment\n::: callout-note\n## This number is smaller than our original estimate without half-cycle correction (44.825!)\n:::\n:::\n\n## Summary\n\n- Once we have total (discounted, half-cycle corrected) outcomes for each strategy, we can turn to conducting incremental cost-effectiveness analysis.\n- We covered these methods yesterday!\n\n## Markov Models\n\n| Pros                                                        | Cons                                                                   |\n|------------------------------------|------------------------------------|\n| Can model repeated events                                   | Can only transition once in a given cycle                              |\n| Can model more complex + longitudinal clinical events       | Shortening the cycle can create computational challenges.              |\n| Not computationally intensive; efficient to model and debug | Shortening cycle can cause \"state explosion\" if tunnel states are used |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n# Next up: Markov Case Study {background=\"#43464B\"}\n","srcMarkdownNoYaml":"\n\n```{r}\n#| echo: false\n#| message: false\n#| warning: false\n\nlibrary(readr)\nlibrary(here)\nlibrary(gt)\nsource(here::here(\"_healthy-sick-dead/01-healthy-sick-dead_setup.r\"))\nsource(here('_healthy-sick-dead/functions_healthy-sick-dead.r'))\nsource(here(\"_healthy-sick-dead/02_healthy-sick-dead_process-parameters.r\"))\nsource(here(\"_healthy-sick-dead/04_healthy-sick-dead_discounting-and-cycle-adjustments.r\"))\nsource(here(\"_healthy-sick-dead/05_healthy-sick-dead_construct-transition-probability-matrices.r\"))\n```\n\n# Learning Objectives and Outline\n\n## Learning Objectives\n\n::: incremental\n-   Discuss pros and cons of decision modeling using decision trees vs.\n    a formal deterministic model\n\n-   Understand the components and structure of discrete time Markov\n    models\n\n-   Calculate Markov cycles by hand, using Markov bubble diagram\n\n-   Apply methods for Markov cycle correction\n:::\n\n## A Simple Disease Process\n\n::: incremental\n-   Suppose we want to model the cost-effectiveness of alternative\n    strategies to prevent a disease from occurring.\n-   We start with a healthy population of 25 year olds and there are\n    three health states people can experience:\n    1.  Remain **Healthy**\n    2.  Become **Sick**\n    3.  **Death**\n:::\n\n## A Simple Disease Process\n\n::: incremental\n-   Remaining healthy carries no utility decrement (utility weight = 1.0\n    per cycle in healthy state)\n-   Becoming sick carries a 0.25 utility decrement for the remainder of\n    the person's life (utility weight = 0.75)\n-   Death carries a utility value of 0.\n:::\n\n## A Simple Disease Process\n\n::: incremental\n-   There is no cost associated with remaining healthy.\n-   Becoming sick incurs \\$1,000 / year in costs.\n-   Becoming sick increases the risk of death by 300%.\n:::\n\n## A Simple Disease Process\n\nA country's health institute is considering five preventive care\nstrategies that reduce the risk of becoming sick:\n\n| Strategy | Description                                      | Cost         |\n|----------|--------------------------------------------------|--------------|\n| A        | Standard of Care                                 | \\$25/year    |\n| B        | Additional 4% reduction in risk of becoming sick | \\$1,000/year |\n| C        | 12% reduction in risk                            | \\$3,100/year |\n| D        | 8% reduction in risk                             | \\$1,550/year |\n| E        | 8% reduction in risk                             | \\$5,000/year |\n\n## Model Option 1: Decision Tree\n\n-   One option would be to use a decision tree to model the expected\n    utility and costs associated with each strategy.\n-   Model time horizon: 10 years\n-   The next slide shows the decision tree for outcomes experienced in\n    the first year.\n\n##  {background-image=\"images/paste-01F7F5A9.png\" data-background-size=\"contain\"}\n\n<!-- Note: Data to construct are contained in media/decision_tree_markov_health_sick_dead_1y.Rdata -->\n\n## Model Option 1: Decision Tree {background-image=\"images/paste-01F7F5A9.png\" data-background-size=\"contain\" background-opacity=\"0.4\"}\n\n-   What limitations do you see?\n\n##  {background-image=\"images/paste-55AF9B31.png\" data-background-size=\"contain\"}\n\nDecision tree for two full cycles.\n\n<!-- Note: Data to construct are contained in media/decision_tree_markov_health_sick_dead_2y.Rdata -->\n\n##  {background-image=\"images/paste-AAAFE3F8.png\" data-background-size=\"contain\"}\n\nStrategy A decision tree for 5 cycles.\n\n<!-- Note: Data to construct are contained in media/decision_tree_markov_health_sick_dead_5y.Rdata -->\n\n## Decision Trees\n\n| Pros                                 | Cons |\n|--------------------------------------|------|\n| Simple, rapid & can provide insights |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons |\n|--------------------------------------|------|\n| Simple, rapid & can provide insights |      |\n| Easy to describe & understand        |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons |\n|--------------------------------------|------|\n| Simple, rapid & can provide insights |      |\n| Easy to describe & understand        |      |\n| Works well with limited time horizon |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons                                 |\n|------------------------------------|------------------------------------|\n| Simple, rapid & can provide insights | Difficult to include clinical detail |\n| Easy to describe & understand        |                                      |\n| Works well with limited time horizon |                                      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons                                   |\n|------------------------------------|------------------------------------|\n| Simple, rapid & can provide insights | Difficult to include clinical detail   |\n| Easy to describe & understand        | Elapse of time is not readily evident. |\n| Works well with limited time horizon |                                        |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n| Pros                                 | Cons                                                |\n|------------------------------------|------------------------------------|\n| Simple, rapid & can provide insights | Difficult to include clinical detail                |\n| Easy to describe & understand        | Elapse of time is not readily evident.              |\n| Works well with limited time horizon | Difficult to model longer (\\>1 cycle) time horizons |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Decision Trees\n\n![](images/markov1.png)\n\n## Next Steps\n\n-   Ideally we want a modeling approach that can incorporate flexibility\n    and handle the complexities that make decision trees\n    difficult/unwieldy.\n\n# Markov Models {background=\"#43464B\"}\n\n## Markov Models\n\nCommon approach in decision analyses that adds additional flexibility.\n\n| Pros                                  | Cons |\n|---------------------------------------|------|\n| Can model repeated events             |      |\n| $\\quad \\quad \\quad \\quad \\quad \\quad$ |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Markov Models\n\nCommon approach in decision analyses that adds additional flexibility.\n\n| Pros                                                  | Cons |\n|-------------------------------------------------------|------|\n| Can model repeated events                             |      |\n| Can model more complex + longitudinal clinical events |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Markov Models\n\nCommon approach in decision analyses that adds additional flexibility.\n\n| Pros                                                        | Cons |\n|-------------------------------------------------------------|------|\n| Can model repeated events                                   |      |\n| Can model more complex + longitudinal clinical events       |      |\n| Not computationally intensive; efficient to model and debug |      |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## Markov Models\n\n::: incremental\n-   The advantages of Markov models derive from their structure around\n    mutually exclusive disease states.\n\n-   These disease states represent the possible states or consequences\n    of strategies or options under consideration.\n\n-   Because there are a fixed number of disease states the population\n    can be in, there is no need to model complex pathways, as we saw in\n    the decision tree \"explosion\" a few slides back.\n:::\n\n## Markov Trees\n\nIt is also common to pair a Markov model with a decision tree.[^1]\n\n[^1]: Gasauskas et al. 2022\n\n::: columns\n::: {.column width=\"50%\"}\n![](media/lec_conceptual-and-theoretical-frameworks/dt_hboc.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n:::\n:::\n\n## Markov Trees\n\nIt is also common to pair a Markov model with a decision tree.[^2]\n\n[^2]: Gasauskas et al. 2022\n\n::: columns\n::: {.column width=\"50%\"}\n![](media/lec_conceptual-and-theoretical-frameworks/dt_hboc.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](media/lec_conceptual-and-theoretical-frameworks/mar_hboc.png){fig-align=\"center\"}\n:::\n:::\n\n## Markov Tree {.smaller}\n\nA simple decision tree is implicit in nearly every decision analysis.\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-13DB786D.png){fig-align=\"center\" height=\"500px\"}\n:::\n\n::: {.column width=\"50%\"}\n:::\n:::\n\n## Markov Tree: Example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-13DB786D.png){fig-align=\"center\" height=\"500px\"}\n:::\n\n::: {.column width=\"50%\"}\nTreatment A:![](images/paste-BA42AD3E.png)\n:::\n:::\n\n## Markov Tree: Example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/caroline_model1.png){fig-align=\"center\" height=\"500px\"}\n:::\n\n::: {.column width=\"50%\"}\nTreatment A:![](images/caroline_model2.png)\n:::\n:::\n\n## When choosing a model structure...\n\n<br>\n\n> \"Things should be made as simple as possible, but not simpler\" -\n> Albert Einstein\n\n::: notes\n(1) When choosing a model structure, you want to choose one that best\n    fits your research question & one that adequately represents the\n    clinical background/problem -- zeroing in on what's most important\n\n(2) You always want to first build the structure completely\n    independently & data free AND then see how hard it is to get data +\n    calibrate\n\n(3) **You never want to model based on the data**\\* nor do you ever want\n    to make something complicated just to make it complicated\\*\\*\n\n(4) Just because a model is \"super complicated/complex\" doesn't mean\n    it's more publishable or better than something that's more\n    simplistic\n:::\n\n```{r, eval = FALSE}\n#| echo = FALSE\n\n\nlibrary(tidygraph)\nlibrary(ggraph)\nlibrary(igraph)\nlibrary(DiagrammeR)\n\ndt_healthysickdead <- \n  mermaid(\"graph LR\n    Healthy0[ ]---|Healthy|Healthy[ ]\n    Healthy---|Treatment A|TxA(M)\n    Healthy---|Treatment B|TxB(M)\n    Healthy---|Treatment C|TxC(M)\n    Healthy---|Treatment D|TxD(M)\n    Healthy---|Treatment E|TxE(M)\n    style Healthy0 fill:#ffffff,stroke:#333,stroke-width:0px\n    style TxA fill:#ffffff,stroke:#333,strike-width:0px\n    style TxB fill:#ffffff,stroke:#333,strike-width:0px\n    style TxC fill:#ffffff,stroke:#333,strike-width:0px\n    style TxD fill:#ffffff,stroke:#333,strike-width:0px\n    style TxE fill:#ffffff,stroke:#333,strike-width:0px\"); dt_healthysickdead \n\n\n## Treatment A\n\nm_P <- matrix(c(\n  0.9822,0,0.0178,\n               0.1376, .8556,0.0068,\n                0,0,1),\n              nrow=3,\n              byrow=TRUE,\n              dimnames=list(c(\"Sick\",\"Healthy\",\"Dead\"),\n                            c(\"Sick\",\"Healthy\",\"Dead\"))); m_P\n\n\ng <- graph.adjacency(m_P>0, mode=\"directed\", weighted=TRUE)\nE(g)$weight2 <- sprintf(c(.9822,.0178,.1376,.8556,.0068,1.00),fmt=\"%3.3f\")\n\ncurve.reciprocal.edges <- function(g, curve=.3){\n  # Return a graph where the edge-attribute $curved is reset to highlight reciprocal edges\n  el <- t(apply(get.edgelist(g),1,sort))\n  E(g)$curved <- 0\n  E(g)[duplicated(el) | duplicated(el,fromLast =TRUE)]$curved <- curve\n  (g)\n}\n\nset.seed(12343)\nplot(curve.reciprocal.edges(g), vertex.size=100, \n     vertex.color = \"white\",\n     vertex.label.color = \"black\",\n     edge.label = E(g)$weight2 ,\n     arrow.size=100, label.cex=3)\n\n```\n\n# Constructing a Markov Model {background=\"#43464B\"}\n\n## Key characteristics {.smaller}\n\n::: incremental\n-   Allows for health state transitions [over\n    time]{style=\"background-color: yellow;\"}\n-   Individuals can only exist in one state at a time (mutually\n    exclusive health states)\n-   At the beginning or end of each cycle, patients transition across\n    health states via transition probabilities & individuals stay in\n    health state [for entire cycle\n    length]{style=\"background-color: yellow;\"}\n-   Probability of transitioning depends on the current state (\"no\n    memory\"); (tunnel states can account for this potential limitation)\n-   Transition probabilities remain constant over time (apart from\n    embedded lifetables)\n-   Results report \"average\" of cohort\n:::\n\n## Key characteristics {.smaller}\n\n<br>\n\n> \"CYCLE\" = Minimum amount of time that any individual will spend in a\n> state before possible transition to another state\n\n-   More on this in the next slides\n\n## Steps\n\n1.  Define the decision problem\n2.  Conceptualize the model\n3.  Parameterize the model\n4.  Calculate or define the transition probability matrix\n5.  Run the model\n\n# 1. Define the Decision Problem {background=\"#c2f0c2\"}\n\n## Step 1: Define the Decision Problem\n\nWe defined the decision problem earlier in this lecture, so we'll repeat\nthe basic objectives briefly here.\n\n## Step 1: Define the Decision Problem\n\n**Goal:** model the cost-effectiveness of alternative strategies to\nprevent a disease from occurring.\n\n| Strategy | Description                                      | Cost         |\n|----------|--------------------------------------------------|--------------|\n| A        | Standard of Care                                 | \\$25/year    |\n| B        | Additional 4% reduction in risk of becoming sick | \\$1,000/year |\n| C        | 12% reduction in risk                            | \\$3,100/year |\n| D        | 8% reduction in risk                             | \\$1,550/year |\n| E        | 8% reduction in risk                             | \\$5,000/year |\n\n## Step 1: Define the Decision Problem\n\n![](images/paste-13DB786D.png){fig-align=\"center\"}\n\n# 2. Conceptualize the Markov Model {background=\"#c2f0c2\"}\n\n## 2. Conceptualize the Markov Model\n\nTwo major steps:\n\n### {{< fa check-circle >}} 2a. Determine health states\n\n### {{< fa check-circle >}} 2b. Determine transitions\n\n## Step 2: Conceptualize the Model\n\n### {{< fa check-circle >}} 2a. Determine health states\n\n::: incremental\n-   There are three health states people can experience:\n    1.  Remain **Healthy**\n    2.  Become **Sick**\n    3.  **Death**\n:::\n\n## Step 2: Conceptualize the Model\n\n### {{< fa check-circle >}} 2a. Determine health states\n\n::: nonincremental\n-   There three health states people can experience:\n    1.  Remain **Healthy**\n    2.  Become **Sick**\n    3.  **Death**\n:::\n\n### {{< fa check-circle >}} 2b. Determine transitions\n\n::: incremental\n-   Individuals who become sick cannot transition back to healthy.\n:::\n\n## \"Bubble Diagram\"\n\nState transition (\"bubble\") diagrams are useful visualizations of a\nMarkov model.\n\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy;\n    Sick -> Sick;\n    Healthy -> Sick; \n    Sick -> Dead;\n    Healthy -> Dead;\n    Dead -> Dead;\n  }\n```\n\n::: footer\nDiagram constructed using the [Graphviz Visual\nEditor](http://magjac.com/graphviz-visual-editor/)\n:::\n\n# 3. Parameterize the Model {background=\"#c2f0c2\"}\n\n## 3. Parameterize the Model\n\nBasic steps\n\n### {{< fa check-circle >}} 3a. Determine basic model parameters\n\n### {{< fa check-circle >}} 3b. Curate and define model inputs\n\n## 3. Parameterize the Model\n\nBasic steps\n\n### {{< fa check-circle >}} 3a. Determine basic model parameters\n\n::: incremental\n-   Define the population (e.g., 25 year old females)\n-   Define the Markov cycle length (e.g., 1-year cycle)\n-   Define the time horizon (e.g., followed until age 100 or death)\n:::\n\n## 3a. Define the Markov Cycle Length\n\n<!-- https://www.youtube.com/watch?v=bVlMq67HT48 -->\n\n::: incremental\n-   Fundamentally, we're modeling a continuous time process (e.g.,\n    progression of disease).\n-   A discrete time Markov model \"breaks up\" time into \"chunks\" (i.e.,\n    \"cycles\").\n-   A consequence is that the model will show us what fraction start out\n    a cycle in a given state, and what fraction end up in each state at\n    the end of the cycle.\n:::\n\n## 3a. Define the Markov cycle length\n\n::: incremental\n-   Suppose we used a one-year cycle for the healthy-sick-dead model.\n-   Think about the underlying (continuous time) disease process.\n    -   Recall that becoming sick substantially increases the likelihood\n        of death.\n-   If we're not careful, what are we (implicitly) assuming *can* and\n    *can't* happen in a single cycle?\n:::\n\n## 3a. Define the Markov Cycle Length\n\n::: {style=\"padding-top: 200px;\"}\n![](images/paste-9C03CB85.png)\n\n```{r, eval = FALSE}\n#| echo: false\nlibrary(DiagrammeR)\nmermaid(\"\ngantt\n  title One-Year Cycle Length\n  dateFormat  YYYY-MM-DD\n  section Health States\n  Healthy : 2021-01-01, 59d\n  Sick     : 2021-03-01 , 100d\n  Dead     : 2021-06-09 , 206d\n  \")\n```\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\nThe challenge of selecting an appropriate cycle length boils down to how\nwe deal with **competing risks**.\n\n::: columns\n::: {.column width=\"50%\"}\n::: incremental\n-   Competing risks: individuals can transition from their current\n    health state to two or more other health states.\n:::\n:::\n\n::: {.column width=\"50%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy;\n    Sick -> Sick;\n    Healthy -> Sick [color=\"red\"]; \n    Sick -> Dead;\n    Healthy -> Dead [color=\"red\"];\n    Dead -> Dead;\n  }\n```\n:::\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\nThe challenge of selecting an appropriate cycle length boils down to how\nwe deal with **competing risks**.\n\n::: columns\n::: {.column width=\"50%\"}\n::: incremental\n-   If we're not careful, we could effectively rule out the possibility\n    of Healthy {{< fa arrow-right-long >}}\n    Sick{{< fa arrow-right-long >}} Dead within a cycle.\n-   The model would *look like* a basic Healthy\n    {{< fa arrow-right-long >}} Dead transition, but they took a detour\n    through Sick along the way!\n:::\n:::\n\n::: {.column width=\"50%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy;\n    Sick -> Sick;\n    Healthy -> Sick [color=\"blue\"]; \n    Sick -> Dead [color=\"blue\"];\n    Healthy -> Dead [color=\"red\"];\n    Dead -> Dead;\n  }\n```\n:::\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n| Pros                                                        | Cons                            |\n|----------------------------------------------|--------------------------|\n| Can model repeated events                                   | Competing risks are a challenge |\n| Can model more complex + longitudinal clinical events       |                                 |\n| Not computationally intensive; efficient to model and debug |                                 |\n\n## 3a. Define the Markov Cycle Length\n\n-   It may be tempting to simply shorten the cycle length (e.g., use 1\n    day cycle vs. 1 year cycle).\n\n::: incremental\n-   For a 75 year horizon, how many cycles would that be?\n    -   27,375!!!\n-   Any possible issues with this?\n:::\n\n## 3a. Define the Markov Cycle Length\n\n-   Shortening the cycle creates a computational challenge.\n\n::: incremental\n-   Base case requires 27,375 daily cycles.\n-   Now suppose we want to run 2,000 probabilistic sensitivity analysis\n    model runs.\n    -   We now have 57,750,000 cycle runs to contend with!\n:::\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n| Pros                                                        | Cons                                                      |\n|------------------------------------|------------------------------------|\n| Can model repeated events                                   | Can only transition once in a given cycle                 |\n| Can model more complex + longitudinal clinical events       | Shortening the cycle can create computational challenges. |\n| Not computationally intensive; efficient to model and debug |                                                           |\n\n## 3a. Define the Markov Cycle Length\n\nMore challenges ...\n\n## 3a. Define the Markov Cycle Length\n\nMore challenges ...\n\n-   Markov models are \"memoryless\" -- they don't remember what happened\n    before the current cycle.\n    -   If your risk of transition to a sicker health state depends on\n        events that happened earlier in time, the model can't explicitly\n        account for this.\n\n## 3a. Define the Markov Cycle Length\n\nMore challenges ...\n\n-   There are workarounds known as \"tunnel states\" to get around this\n    problem, though these are difficult to do and present their own\n    challenges\n    -   We won't cover them this week but we can provide references if\n        you want to explore!\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n| Pros                                                        | Cons                                                                   |\n|------------------------------------|------------------------------------|\n| Can model repeated events                                   | Can only transition once in a given cycle                              |\n| Can model more complex + longitudinal clinical events       | Shortening the cycle can create computational challenges.              |\n| Not computationally intensive; efficient to model and debug | Shortening cycle can cause \"state explosion\" if tunnel states are used |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n## 3a. Define the Markov Cycle Length {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n::: incremental\n-   It's also advisable to pick a cycle length that aligns with the\n    clinical/disease timelines of the decision problem.\n    -   Treatment schedules.\n    -   Acute vs. chronic condition.\n-   Another option is to incorporate \"short-run\" events that happen\n    early in the course of a disease/intervention within the decision\n    tree, then allow the Markov model to model longer-term health\n    consequences.\n:::\n:::\n\n::: {.column width=\"50%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"];\n    Healthy -> Healthy ;\n    Sick -> Sick ;\n    Healthy -> Sick ; \n    Sick -> Dead ;\n    Healthy -> Dead;\n    Dead -> Dead;\n  }\n```\n:::\n:::\n\n## 3. Parameterize the Model\n\n### {{< fa check-circle >}} 3b. Curate and define model inputs\n\n::: nobullet\n-   {{< fa check-circle >}} 3b.i. Source and define the base case\n    values.\n\n-   {{< fa check-circle >}} 3b.ii. Source and define sources of\n    uncertainty.\n:::\n\n## 3. Parameterize the Model\n\n### {{< fa check-circle >}} 3b. Curate and define model inputs\n\n::: incremental\n-   Rate of disease onset\n-   Health state utilities and costs\n-   Hazard ratios, odds ratios or relative risks for different\n    strategies.\n-   ... and so on.\n:::\n\n## 3. Parameterize the Model\n\nWe defined many of the underlying parameters earlier in this lecture, so\nwe'll repeat them briefly here.\n\n## 3. Parameterize the Model\n\n-   We start with a healthy population of 25 year olds and follow them\n    until age 100 (or death, if earlier).\n\n::: incremental\n-   Remaining healthy carries no utility decrement (utility weight= 1.0)\n-   Becoming sick carries a 0.25 utility decrement for the remainder of\n    the person's life (utility weight = 0.75)\n-   Death carries a utility weight value of 0.\n:::\n\n## 3. Parameterize the Model\n\n-   There is no cost associated with remaining healthy.\n\n::: incremental\n-   Becoming sick incurs \\$1,000 / year in costs.\n-   Becoming sick increases the risk of death by 300%.\n:::\n\n## 3. Parameterize the Model\n\nEach strategy has a different cost and impact on the likelihood of\nbecoming sick.\n\n| Strategy | Description                                      | Cost         |\n|----------|--------------------------------------------------|--------------|\n| A        | Standard of Care                                 | \\$25/year    |\n| B        | Additional 4% reduction in risk of becoming sick | \\$1,000/year |\n| C        | 12% reduction in risk                            | \\$3,100/year |\n| D        | 8% reduction in risk                             | \\$1,550/year |\n| E        | 8% reduction in risk                             | \\$5,000/year |\n\n## 3. Parameterize the Model\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   Often, parameters are drawn from the published literature, and it is\n    important to track the source (published value, assumption, etc.)\n    for each model parameter.\n    -   For example, the percent risk reduction parameter for each\n        strategy may come from different clinical trials.\n    -   The parameter governing death from background causes may be\n        derived from mortality data.\n:::\n\n## 3. Parameterize the Model {.smaller}\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   Some parameters may just be values (e.g., cost of Strategy A is\n    \\$25/yr)\n-   Some parameters may be functions of other parameters.\n    -   For example, suppose we want to follow a cohort of 25 year olds\n        until age 100 or death, if it occurs earlier.\n    -   In that case we have two \"fixed\" parameters: the starting age,\n        and the maximum age.\n    -   We can use these two parameters to infer the total number of\n        cycles we need to run.\n:::\n\n## 3. Parameterize the Model\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   Parameters also have various \"flavors\":\n    1.  Probabilities\n    2.  Rates\n    3.  Hazard ratios\n    4.  Costs\n    5.  Utilities\n    6.  etc.\n:::\n\n## 3. Parameterize the Model\n\n::: {.callout-important appearance=\"simple\"}\nIt is **critical** to follow a formal process for parameterizing your\nmodel.\n:::\n\n::: incremental\n-   All of the above highlight the importance of adopting a formal\n    process for naming and tracking the value, source, and uncertainty\n    distribution of **all** model parameters in one place.\n\n-   We recommend a structured approach based on parameter naming\n    conventions and parameter tables.\n:::\n\n## 3. Parameterize the Model\n\nNaming conventions:\n\n```{r}\nknitr::kable(\n  dplyr::tibble(\n    type = c(\"Probability\",\"Rate\",\"Matrix\",\"Cost\",\"Utility\",\"Hazard Ratio\"),\n    prefix = c(\"p_\",\"r_\",\"m_\",\"c_\",\"u_\",\"hr_\")\n  )\n)\n```\n\n## Parameter Table {.smaller}\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\n#| echo: false\n#| message: false\n#| warning: false\n\n\nrows_to_show <- c(1,2,13,14,17,19:21,41)\n\nparams_raw[rows_to_show,1:7]  %>% gt() %>% \n  tab_header(title = \"Parameter Table\") %>% \n  sub_missing(missing_text=\"\") %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#e1efda\")\n    ),\n    locations = cells_body(\n      rows = c(1:length(rows_to_show))\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#fce4d6\")\n    ),\n    locations = cells_body(\n      rows = c(length(rows_to_show))\n    )\n  ) %>% \n    tab_style(\n    style = list(\n      cell_fill(color = \"#ed7d31\")\n    ),\n    locations = cells_body(\n      columns = c(2),\n      rows = c(length(rows_to_show))\n    )\n  ) \n\n```\n:::\n\n##  {.smaller}\n\n**param** column is the short name of the parameter\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\n \n\nprint_table <- function(target) {\n  params_raw[rows_to_show,1:7]  %>% gt() %>% \n  tab_header(title = \"Parameter Table\") %>% \n  sub_missing(missing_text=\"\") %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#e1efda\")\n    ),\n    locations = cells_body(\n      rows = c(1:length(rows_to_show))\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_fill(color = \"#fce4d6\")\n    ),\n    locations = cells_body(\n      rows = c(length(rows_to_show))\n    )\n  ) %>% \n    tab_style(\n    style = list(\n      cell_fill(color = \"#ed7d31\")\n    ),\n    locations = cells_body(\n      columns = c(2),\n      rows = c(length(rows_to_show))\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_borders(\n        sides = c(\"left\",\"right\"),\n        color = \"darkred\",\n        weight = px(2)\n      )),\n      locations = cells_body(\n        columns = c(target)\n      \n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_borders(\n        sides = c(\"top\"),\n        color = \"darkred\",\n        weight = px(2)\n      )),\n      locations = cells_body(\n        rows = c(1),\n        columns = c(target)\n    )\n  ) %>% \n  tab_style(\n    style = list(\n      cell_borders(\n        sides = c(\"bottom\"),\n        color = \"darkred\",\n        weight = px(2)\n      )),\n      locations = cells_body(\n        rows = length(rows_to_show),\n        columns = c(target)\n    )\n  )\n}\n\nprint_table(1)\n\n\n```\n:::\n\n##  {.smaller}\n\n**base_case** is the parameter value for the base case.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(2)\n```\n:::\n\n##  {.smaller}\n\n**formula** defines model parameter formulas for parameters that are\nfunctions of other model parameters.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(3)\n```\n:::\n\n##  {.smaller}\n\n**description** provides a text description of the parameter.\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(4)\n```\n:::\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n##  {.smaller}\n\n**notes** is an optional column where you add additional notes or\ncontext for the parameter.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(5)\n```\n:::\n\n##  {.smaller}\n\n**distribution** specifies the uncertainty distribution for the\nparameter. It is used for probabilistic sensitivity analyses, which we\ncover in our intermediate (week-long) workshop.\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(6) %>% tab_options(table.width = pct(100))\n```\n:::\n\n##  {.smaller}\n\n::: footer\nNote: Only a subset of model parameters are shown in table.\n:::\n\n**source** provides the source for the parameter. It could be a\npublished research article, an assumption, or just simply an unsourced\nmodeling parameter (e.g., the starting age of the modeled cohort).\n\n::: {style=\"font-size: 0.6em\"}\n```{r}\nprint_table(7)\n```\n:::\n\n# 4. Calculate or define the transition probability matrix {background=\"#c2f0c2\"}\n\n## Defining the Transition Probability Matrix\n\n-   The transition probability matrix is a square matrix that defines\n    the probability of transitioning from one health state to another\n    health state in a single time step.\n\n-   Constructing the matrix is a fairly technical, but fairly\n    straightforward process.\n\n    -   We will skip over this process for now, but come back to it later today!\n\n## Transition Probability Matrix\n\n::: columns\n::: {.column width=\"40%\"}\n```{dot}\n//| fig-align: center\n//| fig-width: 4\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    Sick [pos=\"1,1!\"]; \n    Dead [pos=\"1,-1!\"]\n    Healthy -> Healthy [label=\"0.856\"];\n    Sick -> Sick [label=\"0.982\"];\n    Healthy -> Sick [label=\"0.138\"]; \n    Sick -> Dead [label=\"0.018\"];\n    Healthy -> Dead [label=\"0.007\"];\n    Dead -> Dead [label=\"1.0\"];\n  }\n```\n:::\n\n::: {.column width=\"50%\"}\n|         | Healthy | Sick  | Dead  |\n|---------|---------|-------|-------|\n| Healthy | 0.856   | 0.138 | 0.007 |\n| Sick    | 0       | 0.982 | 0.018  |\n| Dead    | 0       | 0     | 1     |\n:::\n:::\n\n# 5. Run the Model {background=\"#c2f0c2\"}\n\n## Executing the model requires two inputs {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-vstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\n$\\quad \\quad \\quad \\quad \\quad \\quad \\quad \\quad$\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns %>% round(.,3)\n```\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$\\quad \\quad \\quad \\quad$\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns %>% round(.,3)\n```\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP \n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns\n```\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr1\"}\n```{r}\ns%*% P %>% round(.,3)\n```\n:::\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n```{r}\n(s %*% P) %*% P %>% round(.,3)\n```\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: r-hstack\n::: {data-id=\"occ\"}\nHealth State Occupancy at Beginning of Cycle\n:::\n\n::: {data-id=\"m_P\"}\nTransition Probability Matrix\n:::\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n:::\n\n::: columns\n::: {.column width=\"33%\"}\n$s =$\n\n```{r}\ns <- m_P[[1]][,1]  %>% t()\ncolnames(s) <- c(\"H\",\"S\",\"D\")\ns[1,] <- c(1,0,0)\nrownames(s) <- c(\"\")\ns\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr1\"}\n```{r}\ns%*% P %>% round(.,3)\n```\n:::\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr2\"}\n```{r}\n(s%*% P) %*% P %>% round(.,3)\n```\n:::\n:::\n\n::: {.column width=\"33%\"}\n$P =$\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n\n```{r}\nP <- round(m_P[[1]],3)  \ncolnames(P) = rownames(P) = c(\"H\",\"S\",\"D\")\nP\n```\n:::\n\n::: {.column width=\"33%\"}\n$s \\cdot P=$\n\n```{r}\ns %*% P %>% round(.,3)\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n```{r}\n(s %*% P) %*% P %>% round(.,3)\n```\n\n::: {style=\"padding-top: 50px;\"}\n:::\n\n::: {data-id=\"tr3\"}\n```{r}\n((s %*% P) %*% P) %*% P %>% round(.,3)\n```\n:::\n:::\n:::\n\n##  {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy at End of Cycle\n:::\n\n::: {data-id=\"tr1\"}\n```{r}\ns %*% P\n```\n:::\n\n::: {data-id=\"tr2\"}\n```{r}\n(s %*% P) %*% P\n```\n:::\n\n::: {data-id=\"tr3\"}\n```{r}\n((s %*% P) %*% P) %*% P \n```\n:::\n\n## Markov Trace {auto-animate=\"true\" auto-animate-easing=\"ease-in-out\"}\n\n::: {data-id=\"occ1\"}\nHealth State Occupancy Over Ten Cycles\n:::\n\n```{r}\n0:10 %>% map_df(~(s %*% (P %^% .x) %>% data.frame()))  %>% \n  mutate(cycle = 0:10) %>% \n  select(cycle,everything()) %>% \n  print(row.names=FALSE)\n  \n```\n\n##  {data-visibility=\"hidden\"}\n\n```{mermaid}\ngraph LR\n        subgraph Step 1\n        A[ ]==>|Parameterize|Software\n        end\n        Software -->Excel\n        Software -->R\n        Excel --> ExcelModelType[Model Type]\n        R --> RModelType[Model Type]\n        ExcelModelType --> ExcelMarkov[Markov]\n        RModelType --> RMarkov[Markov]\n        RModelType --> RMicro[Microsimulation]\n        RModelType --> RDES[Discrete Event Simulation]\n        style A fill:#ffffde,stroke:#333,stroke-width:0px\n      \n```\n\n## A Markov Model of Cancer {data-visibility=\"hidden\"}\n\n```{dot}\n//| fig-align: center\n//| fig-width: 10\n\ndigraph G {\n    layout = neato;\n    Healthy [pos=\"0,0!\"];\n    \"Stage 1\" [pos=\"-1.5,-1!\"];\n    \"Stage 2\" [pos=\"0,-1!\"];\n    \"Stage 3\" [pos=\"1.5,-1!\" ];\n    \"Remission\" [pos=\"-1.5,-2!\"];\n    Death [pos=\"1.5,-2!\"];\n    Healthy -> \"Stage 1\";\n    Healthy -> Healthy;\n    Healthy ->\"Stage 2\";\n    Healthy -> \"Stage 3\";\n    Healthy -> Death;\n    \"Stage 1\" -> Death; \n    \"Stage 2\" -> Death; \n    \"Stage 3\" -> Death;\n    \"Stage 1\" -> Remission; \n    Remission -> \"Stage 1\";\n    \"Stage 2\" -> Remission; \n    Remission -> \"Stage 2\"; \n    Remission -> Remission; \n    \"Stage 1\" -> \"Stage 1\"\n    \"Stage 2\" -> \"Stage 2\" \n    \"Stage 3\" -> \"Stage 3\"\n    Remission -> Death;\n    \"Stage 1\" -> \"Stage 2\"; \n    \"Stage 2\" -> \"Stage 1\"; \n    \"Stage 2\" -> \"Stage 3\";\n    \"Stage 3\" -> \"Stage 2\"; \n  }\n```\n\n## Transition Probability Matrix {.smaller data-visibility=\"hidden\"}\n\n::: columns\n::: {.column width=\"65%\"}\n```{r}\nround(m_P[[1]],3)  %>% knitr::kable()\n```\n:::\n\n::: {.column width=\"5%\"}\n:::\n\n::: {.column width=\"30%\"}\n-   test\n:::\n:::\n\n::: {#refs}\n:::\n\n# Calculate cycles by hand {background=\"#c2f0c2\"}\n\n## In-class example {.smaller}\n\n::: incremental\n-   A new drug was developed for cancer patients in remission to\n    decrease their chance of relapse\n-   This drug is \\$10,000 per year (2022 USD)\n-   Research question: Is the new drug cost-effective compared to the\n    current standard of care?\n-   Let's say we want to model this over a 4-year time horizon\n:::\n\n## In-class example {.smaller}\n\n<br>\n\n::: {style=\"font-size: 0.6em\"}\n|                      | Standard of Care | New Drug |\n|----------------------|------------------|----------|\n| Healthy to Stage 1   | 5%               |          |\n| Healthy to Stage 2   | 2%               |          |\n| Healthy to Stage 3   | 1%               |          |\n| Stage 1 to Stage 2   | 10%              |          |\n| Stage 1 to Remission | 25%              |          |\n| Stage 2 to Stage 1   | 5%               |          |\n| Stage 2 to Stage 3   | 15%              |          |\n| Stage 2 to Remission | 20%              |          |\n| Stage 3 to Stage 2   | 5%               |          |\n| Stage 3 to Death     | 45%              |          |\n| Remission to Stage 1 | 10%              | 2%       |\n| Remission to Stage 2 | 5%               | 1%       |\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example1.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example2.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example3.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example4.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example5.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example7.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example8.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-NewDrug.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example9.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example10.png){fig-align=\"center\"}\n:::\n:::\n\n## In-class example {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/Mark-example9.png){fig-align=\"center\"\nstyle=\"padding-top: 100px;\"}\n:::\n\n::: {.column width=\"50%\"}\n![](images/Mark-example11.png){fig-align=\"center\"}\n:::\n:::\n\n<!-- ## In-class example {.smaller} -->\n\n<!-- <br> -->\n\n<!-- Markov model be continued in class next week... -->\n\n# Calculating Outcomes {background=\"#c2f0c2\"}\n\n## An example Markov Trace (75 year horizon)\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  |\n|----------|---------|-------|-------|\n| 0        | 1.000   | 0.000 | 0.000 |\n| 1        | 0.856   | 0.138 | 0.007 |\n| 2        | 0.732   | 0.253 | 0.015 |\n| 3        | 0.626   | 0.349 | 0.025 |\n| 4        | 0.536   | 0.429 | 0.035 |\n| 5        | 0.458   | 0.495 | 0.046 |\n| ...      | ...     | ...   | ...   |\n| 75 (End) | 0       | 0.282 | 0.718 |\n:::\n\n## Markov Traces\n\n-   Often we are modeling several competing strategies.\n-   Each strategy has its own transition probability matrix.\n-   Therefore, each strategy will have it's own Markov trace.\n\n## Calculating Outcomes\n\n-   With our markov traces complete, we can calculate expected outcomes\n    (e.g., costs, QALYs, DALYs, etc.).\n-   Much like we did with decision trees, we need to define \"payoffs\"\n    for each health state.\n\n## Defining Payoffs\n\n-   Cost outcomes: Cost of being healthy, sick, dead (including any\n    additional costs of treatment/intervention, if applicable).\n-   QALY outcomes: Utility weight of being healthy (usually 1.0), sick,\n    dead (usually 0.0).\n-   DALY outcomes: Disability weights of being sick (YLD) and remaining\n    life expectancy based on reference life table (YLL)\n\n## Defining Payoffs\n\n::: nonincremental\n-   We can calculate the total payoff for each cycle by multiplying the\n    number or fraction of the cohort in each health state by its payoff\n    value, and adding them together.\n:::\n\nExample Markov Trace (two cycles):\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  |\n|-------|---------|-------|-------|\n| 0     | 1.000   | 0.000 | 0.000 |\n| 1     | 0.856   | 0.138 | 0.007 |\n:::\n\n## Example: Life Years\n\n-   We'll build our example using a simple outcome: expected life years\n    under a given strategy.\n-   Payoffs:\n    -   Healthy: <span style=\"color:green;\">1.0</span>\n    -   Sick: <span style=\"color:green;\">1.0</span> \\[they're still alive!\\]\n    -   Dead: <span style=\"color:green;\">0.0</span>\n\n## Example: Life Years\n\n-   To get the total \"payoff\" for a given cycle, we multiply the\n    fraction of the cohort in a given health state by the payoff\n    associated with that health state.\n-   Do this for each health state, and add them together to get the\n    total.\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY  |\n|-------|---------|-------|-------|-----|\n| 0     | 1.000   | 0.000 | 0.000 |     |\n| 1     | 0.856   | 0.138 | 0.007 |     |\n:::\n\n## Example: Life Years\n\nWhat is the LY \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY  |\n|-------|---------|-------|-------|-----|\n| 0     | 1.000   | 0.000 | 0.000 |     |\n| 1     | 0.856   | 0.138 | 0.007 |     |\n:::\n\n## Example: Life Years\n\nWhat is the LY \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY  |\n|-------|---------|-------|-------|-----|\n| 0     | 1.000   | 0.000 | 0.000 | 1.0 = 1.0 \\* <span style=\"color:green;\">1.0</span> + 0.0 \\* <span style=\"color:green;\">1.0</span> + 0.0 \\* <span style=\"color:green;\">0.0</span>|\n| 1     | 0.856   | 0.138 | 0.007 |     |\n:::\n\n## Example: Life Years\n\nWhat is the LY \"payoff\" for Cycle 1?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | LY                                            |\n|---------------|---------------|---------------|---------------|---------------|\n| 0     | 1.000   | 0.000 | 0.000 | 1.0                                           |\n| 1     | 0.856   | 0.138 | 0.007 | 0.994 = 0.856 * <span style=\"color:green;\">1.0</span> + 0.138 \\* <span style=\"color:green;\">1.0</span> + 0.007 \\* <span style=\"color:green;\">0.0</span> |\n:::\n\n... and so on.\n\n## Example: Life Years\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY                    |\n|----------|---------|-------|-------|-----------------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                     |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993                 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985                 |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975                 |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965                 |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954                 |\n| ...      | ...     | ...   | ...   |                       |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282                 |\n:::\n\n\n## Example: Costs\n\n-   Now suppose we want to calculate costs.\n-   Payoffs:\n    -   Healthy: <span style=\"color:blue;\">\\$0</span>\n    -   Sick: <span style=\"color:blue;\">\\$1,000</span>\n    -   Dead: <span style=\"color:blue;\">\\$0</span>\n\n## Example: Costs\n\nWhat is the Cost \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | Cost |\n|-------|---------|-------|-------|------|\n| 0     | 1.000   | 0.000 | 0.000 |      |\n| 1     | 0.856   | 0.138 | 0.007 |      |\n:::\n\n## Example: Costs\n\nWhat is the Cost \"payoff\" for Cycle 0?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | Cost |\n|-------|---------|-------|-------|------|\n| 0     | 1.000   | 0.000 | 0.000 | 0 = 1.00 \\* <span style=\"color:blue;\">0</span> + 0.0 \\* <span style=\"color:blue;\">1000</span> + 0.0 \\* <span style=\"color:blue;\">0</span>   |\n| 1     | 0.856   | 0.138 | 0.007 |      |\n:::\n\n## Example: Costs\n\nWhat is the cost \"payoff\" for Cycle 1?\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle | Healthy | Sick  | Dead  | Cost                                |\n|-------|---------|-------|-------|-------------------------------------|\n| 0     | 1.000   | 0.000 | 0.000 | 0                                   |\n| 1     | 0.856   | 0.138 | 0.007 | 138 = 0.856\\*<span style=\"color:blue;\">0</span>+0.138\\*<span style=\"color:blue;\">1000</span>+0.007\\*<span style=\"color:blue;\">0</span> |\n:::\n\n... and so on.\n\n\n## Other Outcomes\n\n- We can repeat a similar process for health outcomes (e.g., QALYs, YLDs) by multiplying the \"payoff\" (e.g., utility weight, disability weight) for a given health state by the fraction of the cohort in that health state in the cycle. \n\n# Calculating Total Expected Outcomes\n\n## Total Outcomes \n\n## Total Life Years \n\nLet's look at the Markov trace and cycle outcomes for the Life Year outcome.\n\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle)     |\n|----------|---------|-------|-------|-----------------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                     |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993                 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985                 |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975                 |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965                 |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954                 |\n| ...      | ...     | ...   | ...   |                       |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282                 |\n:::\n\n## Life years\n\nWe can create a new column that accumulates life years over each cycle. \n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle) | LY (cumulative)   |\n|----------|---------|-------|-------|-------------------|-------------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                 | 1                 |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993             | 1 + 0.993 = 1.993 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985             |                   |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975             |                   |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965             |                   |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954             |                   |\n| ...      | ...     | ...   | ...   | ...               |                   |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282             |                   |\n:::\n\n## Life years\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle) | LY (cumulative)           |\n|------------|------------|------------|------------|------------|------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                 | 1                         |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993             | 1.993                     |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985             | 1 + 0.993 + 0.985 = 2.978 |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975             |                           |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965             |                           |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954             |                           |\n| ...      | ...     | ...   | ...   | ...               |                           |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282             |                           |\n:::\n\n## Life years {.smaller}\n\n-   The cumulative LYs for an individual starting in the Healthy state is **44.825**\n\n-   Note that this is within a 75 years time horizon\n\n\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle) | LY (cumulative) |\n|----------|---------|-------|-------|-------------------|-----------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1                 | 1               |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993             | 1.993           |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985             | 2.978           |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975             | 3.954           |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965             | 4.919           |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954             | 5.872           |\n| ...      | ...     | ...   | ...   | ...               | ...             |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282             | **44.825**      |\n:::\n\n\n## Total Outcomes\n\n- We can do a similar exercise to get total costs, total QALYs, total DALYs, etc.\n- However, it's not that simple. There are some extra complications we have to deal with.\n  - Discounting \n  - Cycle correction\n\n# Cycle correction {background=\"#c2f0c2\"}\n\n## The problem\n\n-   In real life, events could occur at any points in a given cycle, but\n    a Markov model assumes all events occur either at the beginning\n    or end of each cycle\n    \n-   Time is continuous, so are survival/event-free survival curves\n-   When we discretize time by using a fixed cycle length, we can make\n    two assumptions\n    -   Suppose this is a simple Well $\\rightarrow$ Dead process\n\n## The problem {.smaller}\n\n::: columns\n::: {.column width=\"50%\"}\n::: fragment\nAssuming death happens at the end of cycle\n(A)![](images/paste-48DC2C4B.png){fig-align=\"center\" width=\"512\"}\n:::\n\n::: fragment\nOverestimates state membership in Well\n:::\n:::\n\n::: {.column width=\"50%\"}\n::: fragment\nAssuming death happens at the start of cycle\n(B)![](images/paste-6C74F22E.png){fig-align=\"center\" width=\"525\"}\n:::\n\n::: fragment\nUnderestimates state membership in Well\n:::\n:::\n:::\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## The problem {.smaller}\n\n![](images/half-cycle.png){width=\"513\"}\n\n::: notes\n1.  When counting subjects at the END of cycle (top visual) (transition\n    happens at beginning of cycle) - you would be underestimating LYs\n\n-   Say you have 10 people & 5 die halfway through, you wouldn't be\n    counting the 5 that started that has accumulated SOME costs &\n    benefits in that cycle; you would only be counting the \"end\"\n    survivors.\n\n2.  If you counted subjects at BEGINNING of cycle (the bottom visual)\n    (transition happens at end of previous cycle), you would be\n    overestimating LYs\n\n-   For example, for these 10 people, they die halfway through the\n    cycle, but you already gave that person the full cycle's benefits &\n    costs at the beginning (even though they shouldn't get the full\n    benefits & costs because they died halfway through)\n:::\n\n## Half-cycle correction\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-1105574D.png)\n:::\n\n::: {.column width=\"50%\"}\n:::\n:::\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## Half-cycle correction\n\n::: columns\n::: {.column width=\"50%\"}\n![](images/paste-F622FD0F.png)\n:::\n\n::: {.column width=\"50%\"}\n::: fragment\n![](images/paste-4F29D3CE.png)\n:::\n:::\n:::\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## Half-cycle correction {.smaller}\n\n![](images/paste-86501A0D.png){fig-align=\"center\"}\n\n-   Multiply the outcomes by 1/2 in the first and last cycle.\n\n-   Shifting the computed, discrete state membership curve to the left\n    by 1/2 cycle.\n\n-   Essentially assuming that events happen in the middle of cycle\n\n[Source](https://doi.org/10.1177/0272989X08315241)\n\n## Half-cycle correction\n\n<br>\n\n![](images/half-cycle2.png)\n\n::: notes\n(1) Intuition behind it -- the image to the left represents\n    underestimation\n\n(2) & you can see if you line that up to the Y-AXIS (center figures),\n    the triangular areas can be seen to be equal to a rectangle one-half\n    cycle wide extending from 0 to 1.\n\n(3) If you add back the original rectangles, the approximation is NOW\n    BETTER -- it has corrected for the underestimation.\n:::\n\n# Apply cycle correction methods to our markov trace...\n\n## Half-cycle correction {.smaller}\n\n-   Multiply the outcomes by 1/2 in the first and last cycle.\n\n::: fragment\n::: {style=\"font-size: 0.7em\"}\n| Cycle    | Healthy | Sick  | Dead  | LY (single cycle, adjusted) | LY (cumulative)     |\n|------------|------------|------------|------------|------------|------------|\n| 0        | 1.000   | 0.000 | 0.000 | 1**\\*0.5**                  | **0.5**             |\n| 1        | 0.856   | 0.138 | 0.007 | 0.993                       | 0.5 + 0.993 = 1.493 |\n| 2        | 0.732   | 0.253 | 0.015 | 0.985                       | 2.478               |\n| 3        | 0.626   | 0.349 | 0.025 | 0.975                       | 3.454               |\n| 4        | 0.536   | 0.429 | 0.035 | 0.965                       | 4.419               |\n| 5        | 0.458   | 0.495 | 0.046 | 0.954                       | 5.372               |\n| ...      | ...     | ...   | ...   | ...                         | ...                 |\n| 75 (End) | 0       | 0.282 | 0.718 | 0.282 **\\*0.5**             | **44.184**          |\n:::\n:::\n\n::: fragment\n::: callout-note\n## This number is smaller than our original estimate without half-cycle correction (44.825!)\n:::\n:::\n\n## Summary\n\n- Once we have total (discounted, half-cycle corrected) outcomes for each strategy, we can turn to conducting incremental cost-effectiveness analysis.\n- We covered these methods yesterday!\n\n## Markov Models\n\n| Pros                                                        | Cons                                                                   |\n|------------------------------------|------------------------------------|\n| Can model repeated events                                   | Can only transition once in a given cycle                              |\n| Can model more complex + longitudinal clinical events       | Shortening the cycle can create computational challenges.              |\n| Not computationally intensive; efficient to model and debug | Shortening cycle can cause \"state explosion\" if tunnel states are used |\n\n: {tbl-colwidths=\"\\[50, 50\\]\"}\n\n# Next up: Markov Case Study {background=\"#43464B\"}\n"},"formats":{"revealjs":{"identifier":{"display-name":"RevealJS","target-format":"revealjs","base-format":"revealjs"},"execute":{"fig-width":10,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","html-math-method":"katex","slide-level":2,"to":"revealjs","incremental":true,"highlight-style":"ayu-mirage","output-file":"lec_7.MarkovModels1.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":false,"quarto-version":"1.8.24","auto-stretch":true,"title":"Markov Models","editor_options":{"chunk_output_type":"console"},"editor":{"markdown":{"wrap":72}},"theme":"slides.scss","slideNumber":true,"logo":"../vchem.png","transition":"fade","backgroundTransition":"fade","footer":"[Back to Website](../index.html)\n"}}},"projectFormats":["html"]}